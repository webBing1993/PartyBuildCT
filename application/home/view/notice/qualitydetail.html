{extend name="public/common"}

{block name="style"}
<title>水质报表</title>
<link rel="stylesheet" href="/home/css/organization/qualityDetail.css">
<link rel="stylesheet" href="/static/sweetalert/sweetalert1.css">
<script src="/static/sweetalert/sweetalert1.min.js"></script>
{/block}

{block name="body"}
<div id="refreshContainer" class="mui-content mui-scroll-wrapper">
    <div class="mui-scroll">
        <div class="mui-slider-group">
            <div class="article">
                <div class="title"><p>{$detail.title}</p></div>
                <div class="note clearfix"><span class="fr">{$detail.create_time|time_format='Y-m-d'}</span></div>
            </div>
            <div class="tableList">
                {$detail.content}
            </div>
            <div class="conclusion">
                结论：
                {$detail.conclusion}
                <div class="note">
                    <span class="fr">
                        <span class="read">{$detail.views}</span>
                        {eq name="visit" value="0"}
                        {eq name="detail.is_like" value="1"}
                        <span class="isgood good_" onclick="isGood(this,0,{$detail.id})">{$detail.likes}</span>
                        {else/}
                        <span class="isgood good" onclick="isGood(this,0,{$detail.id})">{$detail.likes}</span>
                        {/eq}
                        {/eq}
                    </span>
                </div>
            </div>
            <div class="comment">
                <div class="sum">共<span>{$detail.comments}</span>条评论</div>
                <div class="lists">
                    <!-- 评论区循环-->
                    {volist name="comment" id="co"}
                    <div class="list clear">
                        <div class="fl">
                            <img src="{$co.header}" alt="用户" class="user">
                        </div>
                        <div class="fl mid">
                            <div class="name limit">{$co.nickname}</div>
                            <div class="content" >{$co.content}</div>
                            <div class="time">{$co.create_time|time_format="Y-m-d"}</div>
                        </div>
                        {eq name="visit" value="0"}
                        {eq name="co.is_like" value="1"}
                        <div class="fr isgood good_" onclick="isGood(this,0,{$co.id})">{$co.likes}</div>
                        {else/}
                        <div class="fr isgood good" onclick="isGood(this,0,{$co.id})">{$co.likes}</div>
                        {/eq}
                        {/eq}
                    </div>
                    {/volist}
                </div>
            </div>
        </div>
    </div>
</div>
<!-- 评论弹框-->
<div class="bottom clear" onclick="send(this,2,{$detail.id})">
    <div class="myword fl">
        <input type="text" placeholder="说说你的感想！" disabled>
    </div>
</div>
{/block}
{block name="script"}
<script src="/home/js/reset.js"></script>
<script>

    $(function () {
        $("title").text("水质报表");
    });

    window.onload = function () {
        if ($(".lists .list").length < 6) {
            mui('#refreshContainer').pullRefresh().disablePullupToRefresh();
        } else {
            mui('#refreshContainer').pullRefresh().enablePullupToRefresh();
        }
    };
    mui.init({
        pullRefresh : {
            container: "#refreshContainer",
            up : {
                callback : loadScroll
            }
        }
    });
    function loadScroll() {
        var len = $(".lists .list").length;
        $.ajax({
            type: "post",
            url: "{:Url('Notice/qualitydetail')}",
            data: {
                length: len
            },
            beforeSend: function(XMLHttpRequest){
            },
            success:function(data){
                addCourse(data);
                if(data.code == 1){
                    var dataLen =data.data.length;
                    if(data.data.length == 6){
                        mui('#refreshContainer').pullRefresh().endPullupToRefresh(false);
                    }else{
                        mui('#refreshContainer').pullRefresh().endPullupToRefresh(true);
                    }
                }else{
                    mui('#refreshContainer').pullRefresh().endPullupToRefresh(true);
                }
            }
        })
    }
    function addCourse(data) {
        var html = '';
        var lists = data.data;
        var len = lists.length;
        console.log(len);
        for(var i = 0; i< len;i++){
            var list = lists[i];
            html +=
                    '<div class="list clear">'+
                    '<div class="fl">'+
                    '<img src="'+data.header+'" alt="用户头像" class="user">'+
                    '</div>'+
                    '<div class="fl mid">'+
                    '<div class="name limit">'+data.nickname+'</div>'+
                    '<div class="content" >'+inputValue+'</div>'+
                    '<div class="time">'+data.time+'</div>'+
                    '</div>'+
                    '<div class="fr isgood good" onclick="isGood(this,0,'+data.id+')">'+data.likes+'</div>'+
                    '</div>';
        }
        $('.lists' ).prepend(html);
    }
    mui("#refreshContainer").on("touchstart","a",function(){
        $(this).css("backgroundColor","rgba(0,0,0,.1)");
    }).on("touchend","a", function () {
        $(this).css("backgroundColor","transparent");
    });
    mui("#refreshContainer").on("tap","a",function(){
        var url = this.getAttribute("href");
        window.location.href = url;
    });


    var scrollNow = true;//判断下拉请求是否执行中.false为正在请求

    /**
     * 点赞
     *
     */
    var isGood = function(e,type,id){
        console.log(type);
        //样式变化，移到suc
        var n = $(e ).text();
        $(e).toggleClass('good' ).toggleClass('good_');
        $(e ).hasClass('good')?n--:n++;
        $(e ).text(n);
        //type：1文章，2评论
//	var type = $(e ).hasClass('fr')?2:1;
        $.ajax({
            type:"post",
            url:"{:Url('Notice/qualitydetail')}",
            data:{
                type:type,
                aid:id
            },
            success:function(data){

            }
        })
    };
    /**
     * 发送评论
     *
     */
    var send = function(e,type,id){
        swal({
                    title: '',
                    text: '请输入您的评论！',
                    type: 'input',
                    showCancelButton: true,
                    closeOnConfirm: false,
                    cancelButtonText: "取消",
                    confirmButtonText: "确定",
                    animation: "slider-form-top"

                },
                function(inputValue){
                    if (inputValue === false) return false;

                    if (inputValue.length < 1) {
                        swal.showInputError("评论字数不能少于1个字！");
                        return false
                    }

                    if (inputValue.length > 300) {
                        swal.showInputError("您输入的字超过了300！");
                        return false
                    }
                    $.ajax({
                        type:"post",
                        url:"{:Url('Notice/qualitydetail')}",
                        data:{
                            type:type,
                            id:id,
                            comment:inputValue
                        },
                        beforeSend:function(){
                            swal({
                                title: ' ',
                                text: '评论提交中...',
                                showConfirmButton:false
                            });
                        },
                        success:function(data){
                            var data = data.data;
                            var userid = "'"+data.create_user+"'";
                            var html = '';
                            html += '<div class="list clear">'+
                                    '<div class="fl">'+
                                    '<img src="'+data.header+'" alt="用户头像" class="user">'+
                                    '</div>'+
                                    '<div class="fl mid">'+
                                    '<div class="name limit">'+data.nickname+'</div>'+
                                    '<div class="content" >'+inputValue+'</div>'+
                                    '<div class="time">'+data.time+'</div>'+
                                    '</div>'+
                                    '<div class="fr isgood good" onclick="isGood(this,0,'+data.id+')">'+data.likes+'</div>'+
                                    '</div>';
                            $('.lists' ).prepend(html);
                            inputValue="";
                            var sum = $('.sum span' );
                            sum.text(parseInt(sum.text())+1);
                            swal({
                                title: ' ',
                                text: '评论成功',
                                type: 'success',
                                confirmButtonText:'确定',
                                timer:3000
                            });
                        }
                    });
                }
        );
    };
</script>
{/block}